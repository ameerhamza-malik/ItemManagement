{% extends 'base.html' %}
{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h4 mb-0">Items</h1>
      <small class="text-muted">{{ total }} total</small>
    </div>
    <div>
      <a class="btn btn-outline-secondary" href="{{ url_for('index') }}">Reset</a>
    </div>
  </div>

  {% if items|length == 0 %}
    <div class="card">
      <div class="card-body">
        <p class="mb-0">No items found. Click <a href="#" data-bs-toggle="modal" data-bs-target="#createModal">Create</a> to add one.</p>
      </div>
    </div>
  {% else %}
    <div class="row g-3">
      {% for item in items %}
        <div class="col-md-6 col-lg-4">
          <div class="card h-100 shadow-sm">
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">{{ item['title'] }}</h5>
              <p class="card-text text-muted small mb-4">
                {{ (item['description'] or '')[:140] }}{% if item['description'] and item['description']|length > 140 %}…{% endif %}
              </p>
              <div class="mt-auto d-flex justify-content-between align-items-center">
                <div>
                  <a class="btn btn-sm btn-outline-primary" href="{{ url_for('view_item', item_id=item['id']) }}">View</a>
                  {% if current_user.is_authenticated %}
                    <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('edit', item_id=item['id']) }}">Edit</a>
                  {% endif %}
                </div>
                {% if current_user.is_authenticated %}
                  <form method="post" action="{{ url_for('delete', item_id=item['id']) }}" onsubmit="return confirm('Delete this item?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button class="btn btn-sm btn-danger">Delete</button>
                  </form>
                {% endif %}
              </div>
            </div>
            <div class="card-footer small text-muted">#{{ item['id'] }} • {{ item['created_at'] }}</div>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- pagination -->
    <nav class="mt-4" aria-label="Pagination">
      <ul class="pagination justify-content-center">
        <li class="page-item {% if page <= 1 %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('index', q=q, page=page-1) }}" tabindex="-1" aria-disabled="{{ 'true' if page <= 1 else 'false' }}">Previous</a>
        </li>

        {% for p in range(1, total_pages + 1) %}
          <li class="page-item {% if p == page %}active{% endif %}">
            <a class="page-link" href="{{ url_for('index', q=q, page=p) }}">{{ p }}</a>
          </li>
        {% endfor %}

        <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('index', q=q, page=page+1) }}" aria-disabled="{{ 'true' if page >= total_pages else 'false' }}">Next</a>
        </li>
      </ul>
    </nav>
  {% endif %}

  <!-- Create Modal -->
  {% if current_user.is_authenticated %}
  <div class="modal fade" id="createModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered">
      <div class="modal-content">
        <form method="post" action="{{ url_for('create') }}">
          {{ form.hidden_tag() }}
          <div class="modal-header">
            <h5 class="modal-title">Create Item</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              {{ form.title.label(class="form-label") }} <span class="text-danger">*</span>
              {{ form.title(class="form-control" + (" is-invalid" if form.title.errors else "")) }}
              {% if form.title.errors %}
                <div class="invalid-feedback">
                  {% for error in form.title.errors %}
                    {{ error }}
                  {% endfor %}
                </div>
              {% endif %}
            </div>
            <div class="mb-3">
              {{ form.description.label(class="form-label") }}
              {{ form.description(class="form-control" + (" is-invalid" if form.description.errors else "")) }}
              {% if form.description.errors %}
                <div class="invalid-feedback">
                  {% for error in form.description.errors %}
                    {{ error }}
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
            <button class="btn btn-primary">Create</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endif %}
{% endblock %}

{% block scripts %}
  {% if show_create_modal %}
    <script>
      // Open the modal automatically if server set flag (validation error)
      const myModal = new bootstrap.Modal(document.getElementById('createModal'));
      myModal.show();
    </script>
  {% endif %}
{% endblock %}
